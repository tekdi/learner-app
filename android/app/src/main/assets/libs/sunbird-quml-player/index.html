<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUML Player web component demo</title>

    <link rel="stylesheet" href="./styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
      integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
      crossorigin="anonymous"></script>

    <style>
      .player-grid {
        width: 100%;
        height: 100vh;
        margin: 0 auto;
        display: grid;
        padding-top: 0rem;

        @media screen and (max-width:768px) {
          grid-template-columns: 100%;
          gap: 0px;
        }
      }
    </style>
  </head>

  <body>
    <div class="player-grid" id="my-player">
    </div>
    <script type="text/javascript" src="sunbird-quml-player.js"></script>
    <script type="text/javascript">
      function setData() 
      {
        let qumlPlayerConfig=null;
        let questionListUrl=null;
        if(localStorage.getItem("qumlPlayerObject")){
          let jsonObj=JSON.parse(localStorage.getItem("qumlPlayerObject"));
          qumlPlayerConfig=jsonObj?.qumlPlayerConfig;
          questionListUrl=jsonObj?.questionListUrl;
          //alert("in json object "+qumlPlayerConfig);
          //alert("in json object "+questionListUrl);
          //alert(JSON.parse(localStorage.getItem("qumlPlayerObject")))
        }
        if(qumlPlayerConfig!=null && questionListUrl!=null)
        {
          const playerConfig = qumlPlayerConfig;
          let sectionContent = qumlPlayerConfig.metadata;
          const identifierWithoutImg = sectionContent.identifier.replace(".img", "");
          const maxScore = sectionContent.maxScore;
          let trackData = [];
          let apiCalled = false;
          // Need to pass the API URL to fetch the question set
          //window.questionListUrl = 'https://egapi-uat.tekdinext.com/mw/events/camp-question-list';
          window.questionListUrl = questionListUrl;
          const qumlPlayerElement = document.createElement('sunbird-quml-player');
          qumlPlayerElement.setAttribute('player-config', JSON.stringify(playerConfig));
          qumlPlayerElement.addEventListener('playerEvent', (event) => {
            console.log("On playerEvent", event);
          });

          qumlPlayerElement.addEventListener('telemetryEvent', (event) => {
            console.log("On telemetryEvent", event);
            const data = event?.detail;
            let telemetry = {};

            if (data && typeof data?.data === "string") {
              telemetry = JSON.parse(data.data);
            } else if (data && typeof data === "string") {
              telemetry = JSON.parse(data);
            } else if (data?.eid) {
              telemetry = data;
            }

            if (telemetry?.eid === "ASSESS") {
              const edata = telemetry?.edata;

              if (edata?.resvalues && edata?.resvalues.length > 0) {
                const existingDataIndex = trackData.findIndex(
                  (e) => e?.item?.id === edata?.item?.id
                );

                if (existingDataIndex >= 0) {
                  trackData[existingDataIndex] = {
                    ...edata,
                    sectionName: sectionContent?.children?.find(
                      (e) => e?.identifier === telemetry?.edata?.item?.sectionId
                    )?.name,
                  };
                } else {
                  trackData.push({
                    ...edata,
                    sectionName: sectionContent?.children?.find(
                      (e) => e?.identifier === telemetry?.edata?.item?.sectionId
                    )?.name,
                  });
                }
              }
              localStorage.setItem("trackDATA", JSON.stringify(trackData));
            } else if (telemetry?.eid === "END") {
              let originalDuration = event?.detail?.edata?.duration;
              let newDuration = originalDuration / 10;
              let seconds = (newDuration = Math.round(newDuration * 10) / 10);

              localStorage.setItem("totalDuration", seconds);
            }

            const endPageSeen = telemetry?.edata?.extra?.find(
              (item) => item.id === "endpageseen"
            );

            if (endPageSeen && endPageSeen.value === "true" && !apiCalled) {
              apiCalled = true;

              let trackDataOld = localStorage.getItem("trackDATA");
              let trackDataParsed = JSON.parse(trackDataOld);
              let scoreDetails;

              const newFormatData = trackDataParsed.reduce((acc, obj) => {
                const existingSection = acc.find(
                  (e) => e.sectionId === obj["item"]["sectionId"]
                );

                if (existingSection) {
                  existingSection.data.push(obj);
                } else {
                  acc.push({
                    sectionId: obj["item"]["sectionId"],
                    sectionName: obj["sectionName"] || "",
                    data: [obj],
                  });
                }
                return acc;
              }, []);

              //scoreDetails = JSON.stringify(newFormatData);
              scoreDetails = newFormatData;

              const secondsString = localStorage.getItem("totalDuration");
              const seconds = Number(secondsString);

              try {
                let result_submit={scoreDetails:scoreDetails,identifierWithoutImg:identifierWithoutImg,maxScore:maxScore,seconds:seconds};
                window.ReactNativeWebView.postMessage(JSON.stringify(result_submit));
              } catch (error) {
                console.error("Error submitting assessment:", error);
              }
            } else {
              console.log("End page not seen, API call not made.");
            }
          });

          const myPlayer = document.getElementById("my-player");
          myPlayer.appendChild(qumlPlayerElement);
        }
        else
        {
          alert("Invalid playerConfig");
        }
      }
    </script>
  </body>

</html>


<!--
  Steps to run locally:
  1. Install http-server npm package locally `npm i http-server -g`
  2. Build the web component using `npm run build-web-component`
  3. Run the server using `http-server --cors web-component .`
-->